

作为一名页面仔，在正常开发过程中极少与编译和链接打交道。只知道xcode的run成功之后就把app安装到手机上了。那么run究竟做了哪些事情呢？

其实主要就做了这么几件事：
- 编译
- 静态链接
- 代码签名
- 动态链接

这篇就先探讨一下编译和静态链接。


## 编译

至今还记得读本科时的三大"挂王"，编译原理就名列其中。研究生复试时也被问到了相关内容，这玩意就是临时抱佛脚看两眼，看完就忘了，因为实在是用不到。今天就再来复习一下吧。

编译可以分为以下几个部分：
- 预编译
- 词法分析
- 语法分析
- 语义分析
- 生成中间代码及优化
- 目标代码生成
- 目标代码优化

#### 预编译

预编译可以理解为编译前的准备工作，主要完成这么几件事：

> - 删除所有的#define，展开所有的宏定义
> - 处理条件编译指令，比如#if, #else, #endif等
> - 处理所有的#include预编译指令，将被include的文件插入到预编译指令的位置
> - 删除所有的注释
> - 添加行号和文件名标识，用于编译器产生调试用的行号信息以及编译时给出的错误和警告的行号信息
> - 保留所有的#pragma指令，编译器会使用


#### 词法分析、语法分析

这2点就不展开了，都是对源代码进行一些改写，生成抽象语法数。

#### 语义分析

前两步只是改造源代码，并不对源代码是否有误进行判断，此处会进行一些类型检查，比如把int付给了string，会给出错误提示。

#### 生成中间代码及优化

之所以存在中间代码，是为了解决多源语言，多机器的问题，使用不同高级语言编写的代码，编译完之后需要运行在不同的机器之上。

如果不存在中间代码，编译器需要为每个源语言+机器的组合实现一个单独的版本，这显然不现实。

有了中间代码，编译器前端负责将不同的源代码生成统一的中间代码，编译器后端负责将中间代码生成不同的目标机器码。当增加一种高级语言时，增加一套前端；增加一种机器时，增加一套后端。

代码优化包括：代码外提，删除无用代码，删除公共子表达式等。

- 代码外提：主要在循环结构中使用，这样能成倍的提高代码的运行效率。
- 删除公共表达式：对于相同的三地址代码可以进行合并，删除。
- 删除无用代码：对于一些临时变量和没有使用的代码可以进行删除。

补充一点，这里所说的机器并不是增加一个型号就多了一种，本质上是指不同的目标文件格式。常见的比如linux上的ELF，windows上的PE，OS X上的mach-o。这些都属于coff格式。关于目标文件的格式这里就不展开说了。

#### 目标代码生成

这一步已经是编译器后端做的事了，其实就是把一条一条的中间代码翻译成机器指令。

#### 目标代码优化

本质上和中间代码优化的目的是一致的，只是针对的是不同的代码。


## 静态链接

静态链接